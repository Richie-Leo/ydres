**[Postman](https://www.postman.com/)**: HTTP接口测试，GUI工具，有Mac、Windows、Linux版本，维护和管理测试集，运行、查看和分析测试结果。<br />
**[newman](https://github.com/postmanlabs/newman)**: 命令行工具，NodeJS开发，执行`Postman`测试，用于与CI集成进行自动化测试。<br />
**[xmysql](https://github.com/o1lab/xmysql)**: 可用于`Postman`连接MySQL，执行数据初始化、数据清除任务。

### 安装部署
`Postman`直接从官网下载安装即可，使用比较简单。<br />
`newman`和`xmysql`都是`nodejs`应用，通过`npm`安装。Docker容器运行参考[liuzhibin-cn/mydemo/postman](https://github.com/liuzhibin-cn/my-demo/tree/master/postman)。

### Postman功能
<img src="https://richie-leo.github.io/ydres/img/10/191/1000/postman.jpg" style="width:99%; max-width:1000px;" />

#### 组织方式：`Collection`, `Folder`, `Request`
1. `Request`：单个HTTP接口测试。
   - 参数化：URL地址、参数、Cookie、Header等，都支持变量参数化。
2. `Folder`：用于组织大量测试用例，支持父子多层级结构。`Folder`上支持`Pre-request Script`和`Tests`脚本。
3. `Collection`：`Postman`中最外层的测试组织结构，可以基于`Collection`导入导出（例如提供给`newman`执行）、定义测试数据集（CVS或者JSON文件，用于迭代）、定义变量。`Collection`也支持`Pre-request Script`和`Tests`脚本。

#### 脚本 `Pre-request Script`, `Tests`
##### 简介
`Collection`、`Folder`、`Request`都可以定义`Pre-request Script`和`Tests`脚本，JavaScript语法：
- `Pre-request Script`：在测试开始运行前执行（JavaScript），用于测试初始化任务。
- `Tests`：在测试结束后执行的脚本（JavaScript），主要用于测试断言。

##### 执行顺序
<img src="https://richie-leo.github.io/ydres/img/10/191/1000/scripts-exec-order.png" style="width:99%; max-width:920px;" />

- 全局对象`pm`的使用参考[Postman Sandbox API reference](https://learning.postman.com/docs/postman/scripts/postman-sandbox-api-reference/#pm)，其中还包括了可以引入的一些`NodeJS`库。
- `Request`、`Response`等详细对象结构参考[Postman SDK](http://www.postmanlabs.com/postman-collection/Response.html)。
- 测试断言语法参考[Assertion API](https://learning.postman.com/docs/postman/scripts/postman-sandbox-api-reference/#pmtest)和[ChaiJS BDD](https://www.chaijs.com/api/bdd/)。

##### 示例
`Pre-request Script`示例：
```js
const mobile = pm.request.url.query.get('mobile');
const password = pm.request.url.query.get('password');
console.log('[user] [register] User to be registered: ' + mobile + " : " + password);
// Save mobile and password as local variables
pm.variables.set('user-mobile', mobile);
pm.variables.set('user-password', password);
// Query MySQL if mobile is registered
const url = 'http://' + pm.environment.get('xmysql') + '/api/usr_user_account?_where=(account,eq,' + mobile + ')';
pm.sendRequest(url, function (err, response) {
    if(err) {
        console.log('[user] [register] Can not identify whether the user is registered, MySQL error: ' + err.code);
        const text = response.text();
        if(text) console.log(text);
        return;
    }
    if(response.code!='200' || response.headers.get('Content-Type').indexOf('application/json')<0) {
        console.log('[user] [register] Can not identify whether the user is registered, MySQL error.');
        const text = response.text();
        if(text) console.log(text);
        return;
    } 
    var json = response.json();
    if(json.length<=0) {
        console.log('[user] [register] User ' + mobile + ' not registered');
        return;
    }
    const userId = json[0].user_id;
    console.log('[user] [register] ' + mobile + ' is already registered, userId is ' + userId + ', delete it from MySQL');
    pm.sendRequest(
        { url:'http://' + pm.environment.get('xmysql') + '/api/usr_user_account/' + mobile, method: 'DELETE' }, 
        function(err1, rsp1) {
            if(err1) console.log('[user] [register] Delete user account ' + mobile + ' failed');
        }
    );
    pm.sendRequest(
        { url:'http://' + pm.environment.get('xmysql') + '/api/usr_user/' + userId, method: 'DELETE' }, 
        function(err2, rsp2) {
            if(err2) console.log('[user] [register] Delete user ' + userId + ' failed');
        }
    );
});
```

`Tests`示例：
```js
console.log('[order] [register] Response: ' + pm.response.text());
pm.test('Status code is 200', function () {
    pm.response.to.have.status(200);
});
// Dynamic variables such as $xxx provided by Postman can not be used in Pre-request and Tests scripts.
// In this example it's used in query params.
// pm.request.url.query.get('password') returns {{$randomPassword}} in Pre-request script, 
// and returns the value such as b851JpM_Ej7UwCG in Tests script.
const mobile = pm.request.url.query.get('mobile'); // Random account generated by Postman
const password = pm.request.url.query.get('password'); //Random password generated by Postman
const contentType = postman.getResponseHeader('Content-Type');
postman.setNextRequest('user-login');
var alreadyRegistered = false;
if(contentType.indexOf('application/json')<0) {
    // If already registered, try register again by another random account and password
    if(pm.response.text().indexOf('Account ' + mobile + ' already registered')>=0) {
        alreadyRegistered = true;
        var retries = pm.collectionVariables.get('register-retries');
        if(!retries) retries = 1;
        if(retries>=3) { // Only retry 3 times
            pm.collectionVariables.unset('register-retries');
            return; //Stop all tests here
        }
        console.log('[order] [register] User ' + mobile + ' already registered, try another user account');
        pm.collectionVariables.set('register-retries', retries + 1);
        postman.setNextRequest('register-a-user');
    }
}
if(!alreadyRegistered) {
    var user = pm.response.json();
    // Save user info into collection variables, so the next Requests can use these variables
    pm.collectionVariables.set('user-mobile', mobile);
    pm.collectionVariables.set('user-password', password);
    pm.collectionVariables.set('user-id', user.userId);
    console.log('[order] [register] User register successful, account: ' + mobile + ', password: ' + password + ', userId: ' + user.userId);
    
    pm.test('Content-Type is application/json', function() {
        pm.expect(contentType).to.have.string('application/json');
    });
    pm.test('User id ' + user.userId + ' is valid', function () {
        pm.expect(user.userId).to.above(0);
    });
    pm.test('User mobile is ' + pm.variables.get('user-mobile'), function () {
        pm.expect(user.mobile).to.eql(pm.variables.get('user-mobile'));
    });
}
```

#### 变量：`Global`, `Collection`, `Environment`, `Data`, `Local`
##### 使用参考
`Environment`应当只用来定义本地、生产等不同环境相关的变量。`temporary`即`Local`变量，仅在单个`Request`范围内有效。

```js
// Global variable: has(), get(), set(), unset(), clear()
pm.globals.set("git-lab", "https://10.172.16.209/"); 
pm.globals.unset("git-lab");  //Remove global variable
// Collection variable: has(), get(), set(), unset(), clear()
pm.collectionVariables.set("user-id", "639828"); 
// Environment variable: has(), get(), set(), unset(), clear()
pm.environment.set("mysql-host", "localhost");
// Data variable: 从文件读取的只支持 get() 操作，也可以在scripts中动态生成，参考pm.iterationData对象
pm.iterationData.get("account");
// Local variable: has(), get(), set()，Request执行完成后失效
pm.variables.set("access_token", "xxxx-xxxx-xxxx"); // Set value for local variable
//Access variable at any scope, Local -> Data -> Environment -> Collection -> Global
pm.variables.get("user-id"); 
```

##### 优先级 作用域
<img src="https://richie-leo.github.io/ydres/img/10/191/1000/Variables-Chart.jpg" style="width:99%; max-width:500px;" />

##### 动态变量
`Postman`提供大量动态变量，例如`$guid`、`$randomUUID`、`$randomPassword`等，参考[Dynamic variables](https://learning.postman.com/docs/postman/scripts/postman-sandbox-api-reference/#dynamic-variables)。<br />
这些动态变量不能在`Pre-request Script`和`Tests`脚本中使用，只能在`Request`的Url、Query Param、Headers、Body中使用。在`Pre-request Script`脚本执行时刻这些动态参数值还没有生成，在`Tests`脚本执行时刻，这些动态参数值已经生成。

#### 参数迭代
在`Collection`上指定一个数据文件（CVS或者JSON），每次迭代使用一行数据运行`Collection`测试。也可以在scripts中动态生成（例如从数据库读取），参考pm.iterationData对象。

#### 工作流
默认情况下`Collection`按以下顺序执行测试：
1. 将`Folder`和其中的下层`Folder`、`Request`看作列表，按照列表顺序执行所有`Request`。
2. 最后按顺序执行`Collection`下面的`Request`（直接位于`Collection`中，而非`Folder`）。

可以在`Pre-request Script`和`Tests`的脚本中设定工作流：
```js
postman.setNextRequest('Request Name');
```

`setNextRequest`只能在作用域范围内跳转，例如运行`Collection`则作用域范围为`Collection`，运行`Folder`则作用域范围为`Folder`。

#### Mock Servers
主要用来解决集成测试，或者后端服务还未开发完成，先通过`Postman`的`Mock Server`开发、调试自动化测试。<br />
通过`API Builder`定义、开发API，关联到`Mock Server`，然后定义和执行测试，`Postman`中称为`API-first development`。

### Newman功能
在`Postman`中将`Collection`、`Global`、`Environment`等导出JSON文件，然后用`Newman`在命令行执行测试，生成报告。
```sh
newman run mydemo.postman_collection.json -e docker-env.postman_environment.json --reporters cli,json --reporter-json-export mydemo-report.json
```
<img src="https://richie-leo.github.io/ydres/img/10/191/1000/newman-output.jpg" style="width:99%; max-width:660px;" />

### 持续集成
`Newman`是`Postman`提供与`Jenkins`等持续集成框架整合的方法。
1. 用`Postman`开发、调试测试，导出JSON文件，通过GitHub、GitLab等SCM进行管理。
2. 在`Jenkins`中新建`Freestyle Project`，从SCM下拉`Postman` JSON导出文件。
3. `Jenkins`的Build选择`Execute shell`，执行`newman`命令。<br />
   ```bash
   newman ... --exitCode 1
   ```
   通过`--exitCode 1`告知`Jenkins`测试结果通过或者失败。
4. 在`Jenkins` Build的`Console Output`中查看`newman`执行结果。也可以让`newman`将执行结果输出到文件中保存下来。
5. 可以通过`Jenkins`邮件通知，或者安装钉钉插件，将测试结果实时通知。

### 与JMeter比较
- 性能测试是`JMeter`强项；
- HTTP接口测试方面`JMeter`功能比较完备，使用起来比较别扭，不如`Postman`顺手，`Postman`基于JavaScript语法的脚本更灵活；
- `JMeter` GUI用于编辑测试用例，命令行模式用于性能测试、自动化测试，还可以采用Server模式，在Server上运行测试用例；

<img src="https://richie-leo.github.io/ydres/img/10/191/1000/jmeter.png" style="width:99%; max-width:900px;" />

#### JMeter概念
组织结构：`TestPlan` -> `Thread Group` -> `Sampler`, `Pre/Post-Processors`, `Assertions`, `Listeners`, `Logic Controller`, `Config`。

- `TestPlan`：对应一个Test Project。
- `Thread Group`：对应一个Test Suite，包括`Thread Group`、`setUp/tearDown Thread Group`。
- `Sampler`：对应一个接口测试，或者Test Suite中的测试步骤，例如`HTTP/FTP/JDBC/Java Request`、`TCP Sampler`等。
- `Pre/Post-Processors`：在请求前、后执行的处理器，例如`JDBC/BeanShell Pre/Post-Processors`等。
- `Assertions`：各种断言组件，例如`Response/JSON/XML/BeanShell Assertion`等。
- `Listeners`：监控测试执行过程，生成测试报告的组件，例如`View Results Tree`、`Summary Report`、`Graph Results`、`Response Time Graph`等。
- `Logic Controller`：用来管理Test Suite中的工作流，例如`If/While/ForEach/Switch/Once Only/Random Order/Interleave Controller`等。
- `Config`：对各种配置进行管理的组件，例如`CVS Data Set Config`、`HTTP Header/Cookie/Cache Manager`、`JDBC Connection Configuration`、`User Defined Variables`等。